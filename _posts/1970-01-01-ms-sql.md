---
layout: post
title: SQL 指令筆記
date: 1970-01-01 12:00
author: Poy
comments: true
categories: []
---
## 基本指令

```sql
UPDATE [TableName] SET [Column1] = 'Value1', [Column2] = 'Value2' WHERE [Condition] 
DELETE FROM [TableName] WHERE [Condition]
INSERT INTO [TableName] ([Column1], [Column2], ...) VALUES ('Value1', 'Value2', ...) 
INSERT INTO "TableName1" ("Column1", "Column2", ...) SELECT "Column3", "Column4", ... FROM "TableName2";
```

## 查詢筆數重複的資料

依stud_no欄位查詢stud_no欄位資料重複的筆數

```sql
SELECT stud_no, COUNT(*) AS count
FROM student_data
GROUP BY stud_no
HAVING (COUNT(*) > 1)
```

## 查詢時顯示群組資料中最新一筆的資料(需要一個不重複的 Identity 欄位)

依Date欄位做判斷，顯示最新的紀錄

```sql
SELECT ID, Number, Price, Date 
FROM test AS T
WHERE Date IN (
		SELECT TOP 1 DATE
		FROM test
		WHERE ID = T.ID
		ORDER BY Date DESC
		)
```

## DBLink 連線至另一台資料庫做查詢的動作

參考文章：[SQL Server 使用 OpenQuery 以及傳遞參數](http://poychang.github.io/sql-server-open-query/)

先建立連結

```sql
exec sp_addlinkedserver 'DBName','','SQLOLEDB','127.0.0.1'
exec sp_addlinkedsrvlogin 'DBName','false',null,'sa','password'
go
```

以下範例，在資料表前，先指定哪一個SQL Server

```sql
INSERT INTO Area 
SELECT * FROM DBName.dbo.Area WHERE AreaID = 'US0002'
```

## 建立完 DBlink 後，可使用 OPENQUERY 的方式，對遠端資料庫做查詢

```sql
SELECT * FROM OPENQUERY(PROD, 'select sysdate from dual')
```

## DATEPART 取得年、月、日及其它時間單位值

```sql
SELECT getdate()
	,DatePart(year, getdate()) AS '年'
	,DatePart(month, getdate()) AS '月'
	,DatePart(day, getdate()) AS '日'
	,DatePart(dayofyear, getdate()) AS '本年一月一號至今的天數'
	,DatePart(week, getdate()) AS '第N週'
	,DatePart(weekday, getdate()) AS '星期幾(代號)' --星期日 = 1
	--星期一 = 2
	--星期二 = 3
	--星期三 = 4
	--星期四 = 5
	--星期五 = 6
	--星期六 = 7
	,DATENAME(Weekday, GETDATE()) AS '星期幾'
	,DatePart(hour, getdate()) AS '時'
	,DatePart(minute, getdate()) AS '分'
	,DatePart(second, getdate()) AS '秒'
	,DatePart(millisecond, getdate()) AS '毫秒'
```

資料來源：[MSDN DATEPART (Transact-SQL)](https://msdn.microsoft.com/zh-tw/library/ms174420.aspx?f=255&MSPPError=-2147217396)

## SQL 字串樣式轉換為日期格式 CAST 和 CONVERT

字串格式轉換為日期格式範例：

```sql
-- SQL Server string to date / datetime conversion - datetime string format sql server
-- MSSQL string to datetime conversion - convert char to date - convert varchar to date
-- Subtract 100 from style number (format) for yy instead yyyy (or ccyy with century)
SELECT convert(datetime, 'Oct 23 2012 11:01AM', 100) -- mon dd yyyy hh:mmAM (or PM)
SELECT convert(datetime, 'Oct 23 2012 11:01AM') -- 2012-10-23 11:01:00.000
  
-- Without century (yy) string date conversion - convert string to datetime function
SELECT convert(datetime, 'Oct 23 12 11:01AM', 0) -- mon dd yy hh:mmAM (or PM)
SELECT convert(datetime, 'Oct 23 12 11:01AM') -- 2012-10-23 11:01:00.000
  
-- Convert string to datetime sql - convert string to date sql - sql dates format
-- T-SQL convert string to datetime - SQL Server convert string to date
SELECT convert(datetime, '10/23/2016', 101) -- mm/dd/yyyy
SELECT convert(datetime, '2016.10.23', 102) -- yyyy.mm.dd ANSI date with century
SELECT convert(datetime, '23/10/2016', 103) -- dd/mm/yyyy
SELECT convert(datetime, '23.10.2016', 104) -- dd.mm.yyyy
SELECT convert(datetime, '23-10-2016', 105) -- dd-mm-yyyy
-- mon types are nondeterministic conversions, dependent on language setting
SELECT convert(datetime, '23 OCT 2016', 106) -- dd mon yyyy
SELECT convert(datetime, 'Oct 23, 2016', 107) -- mon dd, yyyy
-- 2016-10-23 00:00:00.000
SELECT convert(datetime, '20:10:44', 108) -- hh:mm:ss
-- 1900-01-01 20:10:44.000
  
-- mon dd yyyy hh:mm:ss:mmmAM (or PM) - sql time format - SQL Server datetime format
SELECT convert(datetime, 'Oct 23 2016 11:02:44:013AM', 109)
-- 2016-10-23 11:02:44.013
SELECT convert(datetime, '10-23-2016', 110) -- mm-dd-yyyy
SELECT convert(datetime, '2016/10/23', 111) -- yyyy/mm/dd
-- YYYYMMDD ISO date format works at any language setting - international standard
SELECT convert(datetime, '20161023')
SELECT convert(datetime, '20161023', 112) -- ISO yyyymmdd
-- 2016-10-23 00:00:00.000
SELECT convert(datetime, '23 Oct 2016 11:02:07:577', 113) -- dd mon yyyy hh:mm:ss:mmm
-- 2016-10-23 11:02:07.577
SELECT convert(datetime, '20:10:25:300', 114) -- hh:mm:ss:mmm(24h)
-- 1900-01-01 20:10:25.300
SELECT convert(datetime, '2016-10-23 20:44:11', 120) -- yyyy-mm-dd hh:mm:ss(24h)
-- 2016-10-23 20:44:11.000
SELECT convert(datetime, '2016-10-23 20:44:11.500', 121) -- yyyy-mm-dd hh:mm:ss.mmm
-- 2016-10-23 20:44:11.500
  
-- Style 126 is ISO 8601 format: international standard - works with any language setting
SELECT convert(datetime, '2008-10-23T18:52:47.513', 126) -- yyyy-mm-ddThh:mm:ss(.mmm)
-- 2008-10-23 18:52:47.513
SELECT convert(datetime, N'23 شوال 1429  6:52:47:513PM', 130) -- Islamic/Hijri date
SELECT convert(datetime, '23/10/1429  6:52:47:513PM',    131) -- Islamic/Hijri date
  
-- Convert DDMMYYYY format to datetime - sql server to date / datetime
SELECT convert(datetime, STUFF(STUFF('31012016',3,0,'-'),6,0,'-'), 105)
-- 2016-01-31 00:00:00.000
-- SQL Server T-SQL string to datetime conversion without century - some exceptions
-- nondeterministic means language setting dependent such as Mar/Mär/mars/márc
SELECT convert(datetime, 'Oct 23 16 11:02:44AM') -- Default
SELECT convert(datetime, '10/23/16', 1) -- mm/dd/yy U.S.
SELECT convert(datetime, '16.10.23', 2) -- yy.mm.dd ANSI
SELECT convert(datetime, '23/10/16', 3) -- dd/mm/yy UK/FR
SELECT convert(datetime, '23.10.16', 4) -- dd.mm.yy German
SELECT convert(datetime, '23-10-16', 5) -- dd-mm-yy Italian
SELECT convert(datetime, '23 OCT 16', 6) -- dd mon yy non-det.
SELECT convert(datetime, 'Oct 23, 16', 7) -- mon dd, yy non-det.
SELECT convert(datetime, '20:10:44', 8) -- hh:mm:ss
SELECT convert(datetime, 'Oct 23 16 11:02:44:013AM', 9) -- Default with msec
SELECT convert(datetime, '10-23-16', 10) -- mm-dd-yy U.S.
SELECT convert(datetime, '16/10/23', 11) -- yy/mm/dd Japan
SELECT convert(datetime, '161023', 12) -- yymmdd ISO
SELECT convert(datetime, '23 Oct 16 11:02:07:577', 13) -- dd mon yy hh:mm:ss:mmm EU dflt
SELECT convert(datetime, '20:10:25:300', 14) -- hh:mm:ss:mmm(24h)
SELECT convert(datetime, '2016-10-23 20:44:11',20) -- yyyy-mm-dd hh:mm:ss(24h) ODBC can.
SELECT convert(datetime, '2016-10-23 20:44:11.500', 21)-- yyyy-mm-dd hh:mm:ss.mmm ODBC
------------
 
-- SQL Datetime Data Type: Combine date & time string into datetime - sql hh mm ss
-- String to datetime - mssql datetime - sql convert date - sql concatenate string
DECLARE @DateTimeValue varchar(32), @DateValue char(8), @TimeValue char(6)
  
SELECT @DateValue = '20120718',
       @TimeValue = '211920'
SELECT @DateTimeValue =
convert(varchar, convert(datetime, @DateValue), 111)
+ ' ' + substring(@TimeValue, 1, 2)
+ ':' + substring(@TimeValue, 3, 2)
+ ':' + substring(@TimeValue, 5, 2)
SELECT
DateInput = @DateValue, TimeInput = @TimeValue,
DateTimeOutput = @DateTimeValue;
/*
DateInput   TimeInput   DateTimeOutput
20120718    211920      2012/07/18 21:19:20 */
```

資料來源：[MSDN CAST 和 CONVERT (Transact-SQL)](https://msdn.microsoft.com/zh-tw/library/ms187928.aspx)

## 使用 SQL 指令取得資料表內的欄位名稱 

```sql
SELECT NAME
FROM SYSCOLUMNS
WHERE ID= Object_ID('[TableName]')
```

## INFORMATION_SCHEMA 是訊息資料庫，其中保存著關於資料庫伺服器所維護的所有其他資料庫的訊息

透過下列 SQL，可找出有具有特定關鍵字的預存程序或函數

```sql
SELECT ROUTINE_NAME, ROUTINE_DEFINITION 
FROM INFORMATION_SCHEMA.ROUTINES 
WHERE ROUTINE_DEFINITION LIKE '%poy%' 
AND ROUTINE_TYPE='PROCEDURE'
ORDER BY ROUTINE_NAME
```

## 取得資料表的欄位名稱

```sql
SELECT NAME FROM SYSCOLUMNS WHERE ID=OBJECT_ID('TableName')
```

搜尋資料庫所有欄位名稱，可以使用這兩種語法

```sql
SELECT * FROM SYSCOLUMNS
SELECT * FROM SYS.COLUMNS
```

取得資料庫中所有資料表的名稱，可以使用以下語法

```sql
SELECT * FROM INFORMATION_SCHEMA.TABLES
```

## 小技巧

```sql
sp_who			--可查看目前連線id
sp_spaceused	--可查詢每一個資料表用了多少硬碟空間 ex: EXEC sp_spaceused Leads
kill			--可直接把該連線刪除
```

## 查詢相關的版本資料

```sql
SELECT RIGHT(LEFT(@@VERSION,25),4) N'產品版本編號' , 
	SERVERPROPERTY('ProductVersion') N'版本編號',
	SERVERPROPERTY('ProductLevel') N'版本層級',
	SERVERPROPERTY('Edition') N'執行個體產品版本',
	DATABASEPROPERTYEX('master','Version') N'資料庫的內部版本號碼',
	@@VERSION N'相關的版本編號、處理器架構、建置日期和作業系統'
```

## 將欄位識別值種子歸零

```sql
DBCC CHECKIDENT(dbo.TableName, RESEED, 0)
```

## 使用 DBCC LOG 來檢視交易記錄檔內容。

`DBCC LOG`: This command is used to view the transaction log for the specified database.

Syntax: `DBCC log ({dbid|dbname}, [, type={-1|0|1|2|3|4}])` 

Where: dbid or dbname - Enter either the dbid or the name of the database

type - is the type of output, and includes these options:

* 0 - minimum information (operation, context, transaction id)
* 1 - more information (plus flags, tags, row length, description)
* 2 - very detailed information (plus object name, index name, page id, slot id)
* 3 - full information about each operation
* 4 - full information about each operation plus hexadecimal dump of the current transaction log's row.
* -1 - full information about each operation plus hexadecimal dump of the current transaction log's row, plus Checkpoint Begin, DB Version, Max XDESID by default, type = 0

To view the transaction log for the master database, run the following command: `DBCC log (master)` 

參考資料：
* [Some Useful Undocumented SQL Server 7.0 and 2000 DBCC Commands](http://www.sql-server-performance.com/ac_sql_server_2000_undocumented_dbcc.asp) 
   
